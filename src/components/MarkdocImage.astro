---
import OptimizedImage from "./OptimizedImage.astro"

interface Props {
  src: string
  alt: string
  title?: string
}

const { src, alt, title } = Astro.props

/*
 * Article images sizing calculation:
 *
 * Articles have max-width of 30rem with dynamic rem scaling.
 * Base font-size: clamp(16px, 0.395vw + 14.42px, 22px)
 *
 * Since the sizes attribute is parsed before CSS, we need to express rem units
 * in terms of pixels and viewport width:
 * - Article content width: 30rem
 * - With dynamic font-size: 30 * clamp(16px, 0.395vw + 14.42px, 22px)
 * - Simplified: clamp(480px, 11.85vw + 432.6px, 660px)
 *
 * For the sizes attribute:
 * - Below 32rem (512px at 16px/rem): calc(100vw - 2rem) = calc(100vw - 32px)
 * - Above 512px: clamp(480px, 11.85vw + 432.6px, 660px)
 *
 * The displayWidth parameter (660px) is the CSS display width at 1x DPR.
 * This will generate srcset widths from 660w up to 2640w (for 4x DPR displays).
 */
const articleMaxWidth = 660 // CSS display width in pixels (30rem at 22px/rem)
const sizesAttr =
  "(max-width: 512px) calc(100vw - 32px), clamp(480px, 11.85vw + 432.6px, 660px)"
---

{
  title ? (
    <figure>
      <OptimizedImage
        src={src}
        alt={alt}
        displayWidth={articleMaxWidth}
        sizesAttr={sizesAttr}
        loading="lazy"
        decoding="async"
      />
      <figcaption>{title}</figcaption>
    </figure>
  ) : (
    <OptimizedImage
      src={src}
      alt={alt}
      displayWidth={articleMaxWidth}
      sizesAttr={sizesAttr}
      loading="lazy"
      decoding="async"
    />
  )
}
