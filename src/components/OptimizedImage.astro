---
// src/components/OptimizedImage.astro
// Minimal wrapper around Astro's Picture component that:
// - Sets AVIF format globally
// - Sets constrained layout globally
// - Passes through custom sizes attribute from our grid calculations
import { Picture } from "astro:assets"

interface Props {
  src: string
  alt: string
  width?: number // Optional: display width (will be inferred if not provided)
  height?: number // Optional: display height (will be calculated from width if not provided)
  originalWidth?: number // Optional: original image width (for aspect ratio calculation)
  originalHeight?: number // Optional: original image height (for aspect ratio calculation)
  sizesAttr?: string // Optional: custom sizes attribute (from getImageDimensions)
  class?: string
  loading?: "lazy" | "eager"
  decoding?: "async" | "sync" | "auto"
  quality?: number
}

const {
  src,
  alt,
  width,
  height,
  originalWidth,
  originalHeight,
  sizesAttr,
  class: className,
  loading = "lazy",
  decoding = "async",
  quality,
} = Astro.props

// Calculate display height from width if we have original dimensions
const displayHeight =
  height ??
  (width && originalWidth && originalHeight
    ? Math.round((originalHeight / originalWidth) * width)
    : undefined)
---

<Picture
  src={src}
  alt={alt}
  width={width}
  height={displayHeight}
  formats={["avif"]}
  fallbackFormat="webp"
  layout="constrained"
  inferSize
  sizes={sizesAttr}
  loading={loading}
  decoding={decoding}
  quality={quality}
  class={className}
/>
