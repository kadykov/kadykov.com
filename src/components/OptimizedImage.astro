---
// src/components/OptimizedImage.astro
// Minimal wrapper around Astro's Image component that:
// - Sets AVIF format globally
// - Sets constrained layout globally
// - Uses inferSize to maintain perfect aspect ratios and share cache with full-width layouts
// - Passes through custom sizes attribute from our grid calculations
import { Image } from "astro:assets"

interface Props {
  src: string
  alt: string
  width?: number // Optional: target display width (used for widths array)
  height?: number // DEPRECATED: Not used - aspect ratio is inferred automatically
  originalWidth?: number // DEPRECATED: Not needed with inferSize
  originalHeight?: number // DEPRECATED: Not needed with inferSize
  sizesAttr?: string // Optional: custom sizes attribute (from getImageDimensions)
  class?: string
  loading?: "lazy" | "eager"
  decoding?: "async" | "sync" | "auto"
  quality?: number
}

const {
  src,
  alt,
  width: targetWidth,
  sizesAttr,
  class: className,
  loading = "lazy",
  decoding = "async",
  quality,
} = Astro.props

// Build props for Image component
// Key insight: Don't specify width/height, use inferSize instead
// This ensures perfect aspect ratio and cache sharing with full-width layouts
const imageProps: any = {
  src,
  alt,
  format: "avif",
  layout: "constrained",
  inferSize: true, // Automatically infer dimensions and maintain perfect aspect ratio
  loading,
  decoding,
  class: className,
}

// If a target width is provided, use it to constrain the srcset
if (targetWidth) {
  imageProps.widths = [targetWidth, 750, 828, 1080, 1280]
}

if (sizesAttr) imageProps.sizes = sizesAttr
if (quality) imageProps.quality = quality
---

<Image {...imageProps} />
