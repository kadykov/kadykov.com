---
// src/components/OptimizedImage.astro
// Wrapper component for optimized images using centralized utility.
// This ensures cache sharing with PhotoGallery and all other image components.
//
// USAGE EXAMPLES:
//
// 1. Simple usage (fetches remote dimensions automatically):
//    <OptimizedImage
//      src="https://example.com/photo.jpg"
//      alt="A beautiful sunset"
//      displayWidth={660}
//    />
//
// 2. Performance-optimized (avoids remote fetch):
//    <OptimizedImage
//      src="https://example.com/photo.jpg"
//      alt="A beautiful sunset"
//      displayWidth={660}
//      sourceWidth={3000}
//      sourceHeight={2000}
//    />
//
// 3. Responsive with sizes attribute:
//    <OptimizedImage
//      src="https://example.com/photo.jpg"
//      alt="A beautiful sunset"
//      displayWidth={660}
//      sizesAttr="(max-width: 768px) 100vw, 660px"
//      sourceWidth={3000}
//      sourceHeight={2000}
//    />
//
// 4. Gallery thumbnail (calculated display width):
//    const classification = classifyPhoto(photo.width, photo.height);
//    const { displayWidth, sizesAttr } = getImageDimensions(classification);
//    <OptimizedImage
//      src={photoUrl}
//      alt="Gallery photo"
//      displayWidth={displayWidth}
//      sizesAttr={sizesAttr}
//      sourceWidth={photo.width}
//      sourceHeight={photo.height}
//    />
//
// 5. Local image (Astro automatically provides dimensions):
//    import localImage from './image.png';
//    <OptimizedImage
//      src={localImage}
//      alt="Local image"
//      displayWidth={660}
//    />
//
import { generateOptimizedImage } from "../utils/imageOptimization"
import type { ImageMetadata } from "astro"

interface Props {
  /** The image source (local ImageMetadata or remote URL string) */
  src: ImageMetadata | string
  /** Alt text for accessibility */
  alt: string

  /**
   * DISPLAY WIDTH: The CSS display width in pixels (at 1x DPR).
   * This determines:
   * 1. The width attribute on the <img> tag (for aspect ratio calculation)
   * 2. Which srcset widths are generated (1x to 4x DPR)
   *
   * Example: displayWidth={313} generates images for 313px-1252px (1x-4x DPR)
   */
  displayWidth?: number

  /**
   * ORIGINAL DIMENSIONS: Source image dimensions for performance optimization.
   * When provided, skips remote image fetching to determine aspect ratio.
   * Both must be provided together to be effective.
   *
   * NOTE: For local images (ImageMetadata), these are automatically extracted
   * from the import and don't need to be specified.
   */
  sourceWidth?: number
  sourceHeight?: number

  /**
   * SIZES ATTRIBUTE: Tells the browser the actual rendered size at different viewports.
   * Use getImageDimensions() from photoClassification.ts for responsive calculations.
   *
   * If not provided but displayWidth is set, auto-generates following Astro's pattern:
   * "(min-width: {displayWidth}px) {displayWidth}px, 100vw"
   *
   * Example: "(max-width: 400px) 228px, (max-width: 1920px) calc(19.16vw + 205.98px), 313px"
   */
  sizesAttr?: string

  /** CSS class name */
  class?: string
  /** Loading strategy (default: "lazy") */
  loading?: "lazy" | "eager"
  /** Decoding strategy (default: "async") */
  decoding?: "async" | "sync" | "auto"
  /** Image quality (default: 60) */
  quality?: number
}

const {
  src,
  alt,
  displayWidth,
  sourceWidth,
  sourceHeight,
  sizesAttr,
  class: className,
  loading = "lazy",
  decoding = "async",
  quality,
} = Astro.props

// Handle both ImageMetadata (local) and string (remote) sources
// For local images (ImageMetadata), pass dimensions only if explicitly overridden
// For remote images, use provided dimensions or let the utility infer them
let imgWidth: number | undefined
let imgHeight: number | undefined

if (typeof src === "object" && "src" in src) {
  // Local image - only pass dimensions if explicitly provided as overrides
  // Otherwise let Astro handle dimensions automatically from ImageMetadata
  imgWidth = sourceWidth
  imgHeight = sourceHeight
} else {
  // Remote image - use provided dimensions if available
  imgWidth = sourceWidth
  imgHeight = sourceHeight
}

// Use centralized image optimization utility
// Pass ImageMetadata directly for local images (enables proper optimization)
// Pass string URL for remote images
const optimized = await generateOptimizedImage({
  src, // ImageMetadata or string - passed as-is
  maxWidth: displayWidth,
  width: imgWidth,
  height: imgHeight,
  originalWidth: imgWidth,
  quality,
})

// Generate default sizes attribute if not provided but displayWidth is set
// This follows Astro's responsive images pattern:
// "(min-width: {displayWidth}px) {displayWidth}px, 100vw"
// Meaning: use displayWidth if viewport is at least that wide, otherwise full viewport
const computedSizes =
  sizesAttr ??
  (displayWidth
    ? `(min-width: ${displayWidth}px) ${displayWidth}px, 100vw`
    : undefined)
---

<img
  src={optimized.src}
  srcset={optimized.srcset}
  sizes={computedSizes}
  width={optimized.width}
  height={optimized.height}
  alt={alt}
  loading={loading}
  decoding={decoding}
  class={className}
/>
