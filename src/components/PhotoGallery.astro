---
import type { PhotoManifestItem } from "../utils/photoManifestSchema"
import { getImage } from "astro:assets"
import { classifyPhoto, getImageDimensions } from "../utils/photoClassification" // Import classification utilities

interface Props {
  photos: PhotoManifestItem[] // Photos for the current paginated view (thumbnails)
  fullPhotoDataset?: PhotoManifestItem[] // Optional: Full dataset for PhotoSwipe context
}

const { photos, fullPhotoDataset } = Astro.props
const imageBaseUrl = "https://share.kadykov.com/"

// Determine the dataset to use for PhotoSwipe. Fallback to current page's photos if full dataset isn't provided.
const pswpDataset =
  fullPhotoDataset && fullPhotoDataset.length > 0 ? fullPhotoDataset : photos

// Pre-calculate classification and dimensions for all photos (used by both PhotoSwipe data and thumbnails)
const photoMetadata = new Map(
  pswpDataset.map((photo) => {
    const classification = classifyPhoto(photo.width, photo.height)
    const dimensions = getImageDimensions(classification)
    return [photo.slug, { classification, dimensions }]
  })
)

// Prepare a simplified dataset for PhotoSwipe to embed as JSON
// Use Astro's layout system to generate consistent srcsets
const photoSwipeJsonData = await Promise.all(
  pswpDataset.map(async (photo) => {
    const photoSrc = `${imageBaseUrl}${photo.relativePath}`

    // Retrieve pre-calculated dimensions for this photo
    const metadata = photoMetadata.get(photo.slug)
    const displayWidth = metadata?.dimensions.displayWidth ?? 640 // Fallback if not found

    // Generate AVIF srcset using Astro's full-width layout (for lightbox full-screen viewing)
    let pswpSrcset = ""
    try {
      const avifLightboxImages = await getImage({
        src: photoSrc,
        format: "avif",
        layout: "full-width", // Let Astro generate appropriate srcset for full-width display
        inferSize: true, // Infer original dimensions to maintain perfect aspect ratio
      })
      pswpSrcset = avifLightboxImages?.srcSet?.attribute || ""
    } catch (e) {
      // console.error(`Failed to generate AVIF srcset for ${photoSrc}:`, e);
      // pswpSrcset will remain empty, PhotoSwipe will use the main 'src'
    }

    // Generate AVIF placeholder/thumbnail using constrained layout
    // This will share cache with the full-width layout at matching widths
    let msrcUrl = photoSrc // Default to original if placeholder fails
    let thumbnailSrcset = "" // Srcset for the gallery thumbnail
    try {
      const placeholderImage = await getImage({
        src: photoSrc,
        format: "avif",
        layout: "constrained", // Generate responsive srcset
        inferSize: true, // Maintain perfect aspect ratio - shares cache with full-width!
        widths: [displayWidth, 750, 828, 1080, 1280], // Limit to reasonable sizes for thumbnails
      })
      if (placeholderImage?.src) {
        msrcUrl = placeholderImage.src // This is the smallest image in the srcset (displayWidth)
      }
      thumbnailSrcset = placeholderImage?.srcSet?.attribute || ""
    } catch (e) {
      // console.error(`Failed to generate AVIF placeholder for ${photoSrc}:`, e);
    }

    return {
      downloadUrl: photoSrc, // Original JPEG for download
      src: photoSrc, // Original JPEG as fallback (for middle-click and when PhotoSwipe fails)
      msrc: msrcUrl, // Small AVIF placeholder (reuses preview width)
      thumbnailSrcset, // Srcset for responsive gallery thumbnail
      w: photo.width, // PhotoSwipe expects 'w' (original dimensions)
      h: photo.height, // PhotoSwipe expects 'h' (original dimensions)
      srcset: pswpSrcset, // AVIF srcset for PhotoSwipe
      title: photo.title || "",
      description: photo.description || "",
      dateTaken: photo.dateTaken || "",
      tags: photo.tags || [],
      slug: photo.slug || "", // Slug for deep linking
    }
  })
)

// Helper function to generate a random rotation angle for Polaroid-style scatter effect
// Uses normal (Gaussian) distribution for more natural-looking scatter:
// - Most cards will be nearly straight (close to 0°)
// - Fewer cards will have extreme rotations
// Returns a value between -maxDegrees and +maxDegrees, with 68% within ±(maxDegrees/2)
function getRandomRotation(maxDegrees: number = 1): number {
  // Box-Muller transform to generate normally distributed random values
  const u1 = Math.random()
  const u2 = Math.random()
  const z0 = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2)

  // z0 is now normally distributed with mean=0, stddev=1
  // Scale so that 2 standard deviations ≈ maxDegrees (95% of values within range)
  const rotation = z0 * (maxDegrees / 2)

  // Clamp to ensure we never exceed maxDegrees (handles extreme outliers)
  return Math.max(-maxDegrees, Math.min(maxDegrees, rotation))
}
---

{
  photos && photos.length > 0 ? (
    // CSS Grid masonry layout with aspect ratio classes
    <ul id="gallery">
      {/* Embed the full dataset for PhotoSwipe, ensuring it's not HTML-escaped */}
      <script
        is:inline
        type="application/json"
        id="photoswipe-data"
        set:html={JSON.stringify(photoSwipeJsonData)}
      />

      {/* Render thumbnails for the current page */}
      {photos.map(async (photo, pageSpecificIndex) => {
        // Find the index of this 'photo' within the 'pswpDataset' (which is fullPhotoDataset)
        // This index is crucial if PhotoSwipe uses a JS dataSource.
        const fullDatasetIndex = pswpDataset.findIndex(
          (p) => p.slug === photo.slug && p.relativePath === photo.relativePath
        )

        const photoSrc = `${imageBaseUrl}${photo.relativePath}` // Original JPEG/PNG src
        const altText = photo.title || photo.description || photo.filename

        // Retrieve the pre-generated data for this photo from photoSwipeJsonData
        // All optimized images (AVIF srcset, WebP fallback, placeholder) are pre-generated
        const pswpEntryForThisPhoto = photoSwipeJsonData.find(
          (entry) => entry.slug === photo.slug && entry.downloadUrl === photoSrc
        )

        // For PhotoSwipe data attributes:
        // href: Original JPEG as fallback (for middle-click and when PhotoSwipe fails)
        // data-pswp-src: Original JPEG for download
        // data-pswp-srcset: AVIF srcset for responsive lightbox display
        // data-pswp-width/height: Original dimensions
        const pswpLinkHref = photoSrc // Always use original JPEG as href fallback
        const pswpDataSrc = pswpEntryForThisPhoto?.downloadUrl || photoSrc
        const pswpWidth = photo.width
        const pswpHeight = photo.height
        const pswpSrcset = pswpEntryForThisPhoto?.srcset || ""

        // Get pre-generated thumbnail data
        const thumbnailSrc = pswpEntryForThisPhoto?.msrc || photoSrc
        const thumbnailSrcset = pswpEntryForThisPhoto?.thumbnailSrcset || ""

        // Retrieve pre-calculated classification and dimensions for this photo
        const metadata = photoMetadata.get(photo.slug)
        const captionClass =
          metadata?.classification.captionClass ?? "caption-bottom"
        const gridClass = metadata?.classification.gridClass ?? "grid-landscape"
        const displayWidth = metadata?.dimensions.displayWidth ?? 640
        const sizesAttr = metadata?.dimensions.sizesAttr ?? "100vw"

        // Generate a random rotation for this card (build-time, not runtime)
        const cardRotation = getRandomRotation(1).toFixed(2) // Random rotation mostly between -1deg and +1deg, rounded to 2 decimal places

        return (
          <li class={`${captionClass} ${gridClass}`}>
            <a
              class="gallery-item"
              href={pswpLinkHref}
              data-pswp-src={pswpDataSrc}
              data-pswp-width={pswpWidth}
              data-pswp-height={pswpHeight}
              data-pswp-srcset={pswpSrcset}
              data-title={photo.title || ""}
              data-description={photo.description || ""}
              data-date={photo.dateTaken || ""}
              data-tags={photo.tags?.join(",") || ""}
              data-slug={photo.slug || ""}
              data-pswp-index={
                fullDatasetIndex === -1 ? pageSpecificIndex : fullDatasetIndex
              }
              target="_blank"
              aria-label={`View image ${altText}`}
            >
              <figure style={`rotate: ${cardRotation}deg;`}>
                <img
                  src={thumbnailSrc}
                  srcset={thumbnailSrcset}
                  sizes={sizesAttr}
                  alt={altText}
                  loading="lazy"
                  decoding="async"
                />
                <figcaption>{photo.title || photo.filename}</figcaption>
              </figure>
            </a>
          </li>
        )
      })}
    </ul>
  ) : (
    <p>No photos to display.</p>
  )
}

<script>
  // This ensures src/scripts/photoswipe.js is processed by Vite/Astro and included in the build.
  // The script itself (photoswipe.js) will then initialize PhotoSwipe on the #gallery.
  import "../scripts/photoswipe.js"
</script>
