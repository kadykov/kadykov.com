---
// src/components/StandaloneShareButton.astro
import { Icon } from "astro-icon/components"
import Dropdown from "./Dropdown.astro"

interface Props {
  shareUrl?: string
  shareTitle?: string
}

const { shareUrl, shareTitle }: Props = Astro.props
---

<Dropdown>
  <Icon name="ri:share-line" slot="trigger" />
  <li>
    <a
      class="share-link-facebook"
      href="#"
      target="_blank"
      rel="noopener noreferrer"
      ><Icon name="ri:facebook-line" /><span>Facebook</span></a
    >
  </li>
  <li>
    <a
      class="share-link-twitter"
      href="#"
      target="_blank"
      rel="noopener noreferrer"
      ><Icon name="ri:twitter-x-line" /><span>Twitter/X</span></a
    >
  </li>
  <li>
    <a
      class="share-link-linkedin"
      href="#"
      target="_blank"
      rel="noopener noreferrer"
      ><Icon name="ri:linkedin-line" /><span>LinkedIn</span></a
    >
  </li>
  <li>
    <a
      class="share-link-telegram"
      href="#"
      target="_blank"
      rel="noopener noreferrer"
      ><Icon name="ri:telegram-line" /><span>Telegram</span></a
    >
  </li>
  <li>
    <a
      class="share-link-whatsapp"
      href="#"
      target="_blank"
      rel="noopener noreferrer"
      ><Icon name="ri:whatsapp-line" /><span>WhatsApp</span></a
    >
  </li>
  <li>
    <a class="share-link-email" href="#"
      ><Icon name="ri:mail-line" /><span>Email</span></a
    >
  </li>
  <hr />
  <li>
    <a class="share-link-copy" href="#"
      ><Icon name="ri:link" /><span>Copy Link</span></a
    >
  </li>
</Dropdown>

<script
  is:inline
  define:vars={{ initialShareUrl: shareUrl, initialShareTitle: shareTitle }}
>
  document.addEventListener("DOMContentLoaded", () => {
    // Find all details elements in header and check if they contain share links
    const headerDetails = document.querySelectorAll("header details")

    headerDetails.forEach((componentRoot) => {
      // Check if this details element contains share links
      const facebookLink = componentRoot.querySelector(".share-link-facebook")
      if (!facebookLink) return // Skip if this isn't a share dropdown

      const shareLinks = {
        facebook: componentRoot.querySelector(".share-link-facebook"),
        twitter: componentRoot.querySelector(".share-link-twitter"),
        linkedin: componentRoot.querySelector(".share-link-linkedin"),
        telegram: componentRoot.querySelector(".share-link-telegram"),
        whatsapp: componentRoot.querySelector(".share-link-whatsapp"),
        email: componentRoot.querySelector(".share-link-email"),
        copy: componentRoot.querySelector(".share-link-copy"),
      }

      const urlToShare = initialShareUrl || window.location.href
      // For title, attempt to get from prop, then document.title, then a fallback.
      let titleToShare =
        initialShareTitle ||
        (typeof document !== "undefined" ? document.title : "")
      // If it's a photo page, try to get a more specific title if one isn't passed.
      if (
        !initialShareTitle &&
        urlToShare.includes("/photos/") &&
        typeof document !== "undefined"
      ) {
        const h1 = document.querySelector("h1")
        if (h1 && h1.textContent) {
          titleToShare = h1.textContent.trim()
        }
      }

      if (shareLinks.facebook) {
        shareLinks.facebook.href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(urlToShare)}`
      }
      if (shareLinks.twitter) {
        shareLinks.twitter.href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(urlToShare)}&text=${encodeURIComponent(titleToShare)}`
      }
      if (shareLinks.linkedin) {
        shareLinks.linkedin.href = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(urlToShare)}`
      }
      if (shareLinks.telegram) {
        shareLinks.telegram.href = `https://t.me/share/url?url=${encodeURIComponent(urlToShare)}&text=${encodeURIComponent(titleToShare)}`
      }
      if (shareLinks.whatsapp) {
        shareLinks.whatsapp.href = `whatsapp://send?text=${encodeURIComponent(titleToShare + " " + urlToShare)}`
      }
      if (shareLinks.email) {
        const emailSubject = encodeURIComponent(titleToShare)
        const emailBody = encodeURIComponent(`${titleToShare}\n\n${urlToShare}`)
        shareLinks.email.href = `mailto:?subject=${emailSubject}&body=${emailBody}`
      }

      if (shareLinks.copy) {
        shareLinks.copy.addEventListener("click", (e) => {
          e.preventDefault()
          navigator.clipboard
            .writeText(urlToShare)
            .then(() => {
              const originalTextElement = shareLinks.copy.querySelector("span")
              if (originalTextElement) {
                const originalText = originalTextElement.textContent
                originalTextElement.textContent = "Copied!"
                // Ensure dropdown closes after copying
                if (componentRoot.hasAttribute("open")) {
                  componentRoot.removeAttribute("open")
                }
                setTimeout(() => {
                  originalTextElement.textContent = originalText
                }, 2000)
              }
            })
            .catch((err) => console.error("Failed to copy URL: ", err))
        })
      }

      // Close dropdown when a social share link is clicked
      // Exclude "Copy Link" and "Email" from this specific auto-close behavior,
      // as they have their own handling or don't navigate away immediately.
      ;[
        shareLinks.facebook,
        shareLinks.twitter,
        shareLinks.linkedin,
        shareLinks.telegram,
        shareLinks.whatsapp,
      ].forEach((link) => {
        if (link) {
          link.addEventListener("click", () => {
            // Use a small delay to allow the link to be processed before closing
            setTimeout(() => {
              if (componentRoot.hasAttribute("open")) {
                componentRoot.removeAttribute("open")
              }
            }, 150)
          })
        }
      })

      // For the email link, we don't want to preventDefault or close the dropdown,
      // as the browser/OS handles opening the mail client.
      // The `href` is already set, so default behavior is fine.
    })
  })
</script>
