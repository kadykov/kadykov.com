---
import BaseLayout from "./BaseLayout.astro"
import Hero from "../components/Hero.astro"
import { slugify } from "../utils/slugify"
import {
  type ReadingTimeResult,
  formatReadingTimeDuration,
} from "../utils/readingTime"
import { getFontPreload } from "../config/fontPreload"

interface Props {
  frontmatter: {
    title: string
    headline?: string
    subtitle?: string
    description: string
    pubDate: Date
    lastUpdatedDate?: Date
    tags: string[]
    [key: string]: any
  }
  readingTime?: ReadingTimeResult
}

const { frontmatter, readingTime } = Astro.props
const { title, headline, subtitle, pubDate, lastUpdatedDate, tags } =
  frontmatter

// Format dates
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  }).format(new Date(date))
}
---

<BaseLayout
  frontmatter={frontmatter}
  fontPreload={getFontPreload({
    heroSubtitle: !!subtitle,
    articleContent: true,
    timeInHero: true,
  })}
>
  <Hero>
    <h1>{headline ?? title}</h1>
    {subtitle && <p>{subtitle}</p>}
    {
      tags && tags.length > 0 && (
        <nav>
          <ul>
            {tags.map((tag: string) => (
              <li>
                <a href={`/blog/tags/${slugify(tag)}`}>#{tag}</a>
              </li>
            ))}
          </ul>
        </nav>
      )
    }
    {
      readingTime && (
        <time datetime={formatReadingTimeDuration(readingTime.minutes)}>
          {readingTime.text}
        </time>
      )
    }
  </Hero>

  <slot />

  <footer>
    <time datetime={pubDate.toISOString()}>
      Published: {formatDate(pubDate)}
    </time>
    {
      lastUpdatedDate && lastUpdatedDate.getTime() !== pubDate.getTime() && (
        <>
          {" â€¢ "}
          <time datetime={lastUpdatedDate.toISOString()}>
            Updated: {formatDate(lastUpdatedDate)}
          </time>
        </>
      )
    }
  </footer>
  <script>
    // Copy code button functionality using event delegation
    document.addEventListener("click", async (event) => {
      const target = event.target
      if (!(target instanceof Element)) return

      // Match buttons inside pre elements (code blocks)
      const button = target.closest("pre button")
      if (!(button instanceof HTMLButtonElement)) return

      // Find the code element sibling
      const pre = button.closest("pre")
      const code = pre?.querySelector("code")
      if (!code) return

      try {
        await navigator.clipboard.writeText(code.textContent ?? "")
        button.classList.add("copied")
        setTimeout(() => button.classList.remove("copied"), 2000)
      } catch (err) {
        console.error("Failed to copy code:", err)
      }
    })
  </script>
</BaseLayout>
