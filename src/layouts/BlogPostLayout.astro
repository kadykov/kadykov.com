---
import BaseLayout from "./BaseLayout.astro"
import Hero from "../components/Hero.astro"
import { slugify } from "../utils/slugify"
import {
  type ReadingTimeResult,
  formatReadingTimeDuration,
} from "../utils/readingTime"
import { getFontPreload } from "../config/fontPreload"

interface Props {
  frontmatter: {
    title: string
    headline?: string
    subtitle?: string
    description: string
    pubDate: Date
    lastUpdatedDate?: Date
    tags: string[]
    [key: string]: any
  }
  readingTime?: ReadingTimeResult
}

const { frontmatter, readingTime } = Astro.props
const { title, headline, subtitle, pubDate, lastUpdatedDate, tags } =
  frontmatter

// Format dates
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  }).format(new Date(date))
}

// Build-time check: detect if content has code blocks
const slotContent = await Astro.slots.render("default")
const hasCodeBlocks = slotContent.includes("<pre")
---

<BaseLayout
  frontmatter={frontmatter}
  fontPreload={getFontPreload({
    heroSubtitle: !!subtitle,
    articleContent: true,
    timeInHero: true,
  })}
>
  <Hero>
    <h1>{headline ?? title}</h1>
    {subtitle && <p>{subtitle}</p>}
    {
      tags && tags.length > 0 && (
        <nav>
          <ul>
            {tags.map((tag: string) => (
              <li>
                <a href={`/blog/tags/${slugify(tag)}`}>#{tag}</a>
              </li>
            ))}
          </ul>
        </nav>
      )
    }
    {
      readingTime && (
        <time datetime={formatReadingTimeDuration(readingTime.minutes)}>
          {readingTime.text}
        </time>
      )
    }
  </Hero>

  <Fragment set:html={slotContent} />

  <footer>
    <time datetime={pubDate.toISOString()}>
      Published: {formatDate(pubDate)}
    </time>
    {
      lastUpdatedDate && lastUpdatedDate.getTime() !== pubDate.getTime() && (
        <>
          {" â€¢ "}
          <time datetime={lastUpdatedDate.toISOString()}>
            Updated: {formatDate(lastUpdatedDate)}
          </time>
        </>
      )
    }
  </footer>
  {
    hasCodeBlocks && (
      // Unfortunately, prettier-plugin-astro does not support <script> element inside {...}
      // and prettier-ignores do not work here, so we have to use set:html workaround
      <>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          style="display: none;"
          aria-hidden="true"
        >
          <symbol id="icon-copy" viewBox="0 0 24 24">
            <path d="M7 6V3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1h-3v3c0 .552-.45 1-1.007 1H4.007A1 1 0 0 1 3 21l.003-14c0-.552.45-1 1.006-1zM5.002 8L5 20h10V8zM9 6h8v10h2V4H9z" />
          </symbol>
          <symbol id="icon-check" viewBox="0 0 24 24">
            <path d="m10 15.17l9.192-9.191l1.414 1.414L10 17.999l-6.364-6.364l1.414-1.414z" />
          </symbol>
        </svg>
        <Fragment
          set:html={`<script>
        document.addEventListener("click", async (event) => {
          const target = event.target;
          if (!(target instanceof Element)) return;
          const button = target.closest("pre button");
          if (!(button instanceof HTMLButtonElement)) return;
          const pre = button.closest("pre");
          const code = pre?.querySelector("code");
          if (!code) return;
          
          const copyText = async (text) => {
            // Try modern Clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
              try {
                await navigator.clipboard.writeText(text);
                return true;
              } catch (err) {
                console.warn("Clipboard API failed, trying fallback:", err);
              }
            }
            
            // Fallback for mobile browsers: use execCommand with textarea
            try {
              const textarea = document.createElement("textarea");
              textarea.value = text;
              textarea.style.position = "fixed";
              textarea.style.left = "-999999px";
              textarea.style.top = "-999999px";
              document.body.appendChild(textarea);
              textarea.focus();
              textarea.select();
              const success = document.execCommand("copy");
              document.body.removeChild(textarea);
              return success;
            } catch (err) {
              console.error("Fallback copy also failed:", err);
              return false;
            }
          };
          
          const success = await copyText(code.textContent ?? "");
          if (success) {
            const use = button.querySelector("use");
            if (use) use.setAttribute("href", "#icon-check");
            button.classList.add("copied");
            setTimeout(() => {
              if (use) use.setAttribute("href", "#icon-copy");
              button.classList.remove("copied");
            }, 2000);
          }
        });
      </script>`}
        />
      </>
    )
  }
</BaseLayout>
