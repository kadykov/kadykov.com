---
import BaseLayout from "../../layouts/BaseLayout.astro"
import { getCollection } from "astro:content"
import type { PhotoManifestItem } from "../../utils/photoManifestSchema"
import OptimizedImage from "../../components/OptimizedImage.astro"
import { PHOTO_SERVER_URL } from "../../config/photoServer"
import { slugify } from "../../utils/slugify"
import { getPhotoAltText, getPhotoDisplayDate } from "../../utils/photoHelpers"

export async function getStaticPaths() {
  // Fetch all photos from the collection
  const photoEntries = await getCollection("photos")
  const allPhotos: PhotoManifestItem[] = photoEntries.map(
    (entry) => entry.data as PhotoManifestItem
  )

  // Generate a path for each photo
  return allPhotos.map((photo) => ({
    params: { slug: photo.slug },
    props: { photo },
  }))
}

interface Props {
  photo: PhotoManifestItem
}

const { photo } = Astro.props
const imageBaseUrl = `${PHOTO_SERVER_URL}/`

// Generate display date and alt text using helpers
const displayDate = getPhotoDisplayDate(photo) || "Unknown date"
const altText = getPhotoAltText(photo, displayDate)

// Generate date URL
let dateUrl: string | null = null

if (photo.dateTaken) {
  dateUrl = `/photos/dates/${photo.dateTaken.substring(0, 10)}/1`
} else if (photo.year && photo.month && photo.day) {
  const monthStr = String(photo.month).padStart(2, "0")
  const dayStr = String(photo.day).padStart(2, "0")
  dateUrl = `/photos/dates/${photo.year}-${monthStr}-${dayStr}/1`
}

// Format exposure time: use fraction for < 1s, direct seconds for >= 1s
let exposureDisplay: string | null = null
if (photo.exposureTime) {
  if (photo.exposureTime < 1) {
    // Format as fraction (e.g., 1/60s)
    const denominator = Math.round(1 / photo.exposureTime)
    exposureDisplay = `1/${denominator}s`
  } else {
    // Format as direct seconds (e.g., 2s)
    exposureDisplay = `${photo.exposureTime}s`
  }
}

// Prepare metadata for the page
const pageTitle = photo.title || `Photo from ${displayDate}`
const pageDescription =
  photo.description || `Photograph taken on ${displayDate}`

// Open Graph image URL (use a medium-sized version)
const ogImageUrl = `${imageBaseUrl}${photo.relativePath}`
---

<BaseLayout
  frontmatter={{
    title: pageTitle,
    description: pageDescription,
    image: ogImageUrl,
  }}
>
  <article>
    <header>
      <h1>{pageTitle}</h1>
      {photo.description && <p class="description">{photo.description}</p>}
    </header>

    <figure>
      <OptimizedImage
        src={`${imageBaseUrl}${photo.relativePath}`}
        alt={altText}
        width={1200}
        originalWidth={photo.width}
        originalHeight={photo.height}
        sizesAttr="(min-width: 1200px) 1200px, 100vw"
        loading="eager"
      />
      {photo.title && <figcaption>{photo.title}</figcaption>}
    </figure>

    <section class="metadata">
      <h2>Details</h2>
      <dl>
        <dt>Date taken</dt>
        <dd>
          {dateUrl ? <a href={dateUrl}>{displayDate}</a> : displayDate}
        </dd>

        {
          photo.cameraModel && (
            <>
              <dt>Camera</dt>
              <dd>
                <a
                  href={`/photos/equipment/cameras/${slugify(photo.cameraModel)}/1`}
                >
                  {photo.cameraModel}
                </a>
              </dd>
            </>
          )
        }

        {
          photo.lensModel && (
            <>
              <dt>Lens</dt>
              <dd>
                <a
                  href={`/photos/equipment/lenses/${slugify(photo.lensModel)}/1`}
                >
                  {photo.lensModel}
                </a>
              </dd>
            </>
          )
        }

        {
          photo.focalLength && (
            <>
              <dt>Focal length</dt>
              <dd>
                {photo.focalLengthCategory ? (
                  <a
                    href={`/photos/equipment/focal-length/${photo.focalLengthCategory}/1`}
                  >
                    {photo.focalLength}mm
                    {photo.focalLength35mmEquiv &&
                      ` (${photo.focalLength35mmEquiv}mm equiv.)`}
                  </a>
                ) : (
                  <>
                    {photo.focalLength}mm
                    {photo.focalLength35mmEquiv &&
                      ` (${photo.focalLength35mmEquiv}mm equiv.)`}
                  </>
                )}
              </dd>
            </>
          )
        }

        {
          photo.apertureValue && (
            <>
              <dt>Aperture</dt>
              <dd>f/{photo.apertureValue}</dd>
            </>
          )
        }

        {
          exposureDisplay && (
            <>
              <dt>Exposure</dt>
              <dd>{exposureDisplay}</dd>
            </>
          )
        }

        {
          photo.isoSpeedRatings && (
            <>
              <dt>ISO</dt>
              <dd>{photo.isoSpeedRatings}</dd>
            </>
          )
        }

        {
          photo.flash === true && (
            <>
              <dt>Flash</dt>
              <dd>
                <a href="/photos/equipment/flash/1">Yes</a>
              </dd>
            </>
          )
        }

        {
          photo.tags && photo.tags.length > 0 && (
            <>
              <dt>Tags</dt>
              <dd>
                {photo.tags.map((tag, index) => {
                  const separator = index < photo.tags!.length - 1 ? ", " : ""
                  return (
                    // Keep separator on same line to prevent unwanted whitespace in rendered HTML
                    // prettier-ignore
                    <>
                      <a href={`/photos/tags/${slugify(tag)}/1`}>#{tag}</a>{separator}
                    </>
                  )
                })}
              </dd>
            </>
          )
        }

        {
          photo.creator && (
            <>
              <dt>Creator</dt>
              <dd>{photo.creator}</dd>
            </>
          )
        }

        {
          photo.copyright && (
            <>
              <dt>Copyright</dt>
              <dd>{photo.copyright}</dd>
            </>
          )
        }

        {
          photo.notes && (
            <>
              <dt>Notes</dt>
              <dd>{photo.notes}</dd>
            </>
          )
        }
      </dl>
    </section>

    <nav>
      <a href="/photos/all/1">‚Üê Back to gallery</a>
      {
        photo.dateTaken && (
          <>
            {" | "}
            <a href={`/photos/dates/${photo.dateTaken.substring(0, 10)}/1`}>
              View all photos from this date
            </a>
          </>
        )
      }
    </nav>
  </article>
</BaseLayout>

<style>
  article {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
  }

  header {
    margin-bottom: 2rem;
  }

  h1 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }

  .description {
    font-size: 1.125rem;
    color: var(--color-text-secondary, #666);
  }

  figure {
    margin: 2rem 0;
  }

  figure img {
    width: 100%;
    height: auto;
    display: block;
  }

  figcaption {
    margin-top: 0.5rem;
    font-style: italic;
    color: var(--color-text-secondary, #666);
  }

  .metadata {
    margin: 3rem 0;
  }

  .metadata h2 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
  }

  dl {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.75rem 1.5rem;
    max-width: 600px;
  }

  dt {
    font-weight: 600;
    color: var(--color-text-secondary, #666);
  }

  dd {
    margin: 0;
  }

  nav {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border, #e0e0e0);
  }

  nav a {
    color: var(--color-link, #06c);
    text-decoration: none;
  }

  nav a:hover {
    text-decoration: underline;
  }
</style>
