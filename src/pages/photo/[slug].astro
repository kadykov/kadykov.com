---
import BaseLayout from "../../layouts/BaseLayout.astro"
import { getCollection } from "astro:content"
import type { PhotoManifestItem } from "../../utils/photoManifestSchema"
import OptimizedImage from "../../components/OptimizedImage.astro"
import PhotoNavigation from "../../components/PhotoNavigation.astro"
import { PHOTO_SERVER_URL } from "../../config/photoServer"
import { slugify } from "../../utils/slugify"
import { getPhotoAltText, getPhotoDisplayDate } from "../../utils/photoHelpers"
import { Icon } from "astro-icon/components"

export async function getStaticPaths() {
  // Fetch all photos from the collection
  const photoEntries = await getCollection("photos")
  const allPhotos: PhotoManifestItem[] = photoEntries.map(
    (entry) => entry.data as PhotoManifestItem
  )

  // Generate a path for each photo with prev/next navigation
  return allPhotos.map((photo, index) => {
    const totalPhotos = allPhotos.length
    const prevIndex = (index - 1 + totalPhotos) % totalPhotos
    const nextIndex = (index + 1) % totalPhotos

    return {
      params: { slug: photo.slug },
      props: {
        photo,
        prevPhotoSlug: allPhotos[prevIndex].slug,
        nextPhotoSlug: allPhotos[nextIndex].slug,
      },
    }
  })
}

interface Props {
  photo: PhotoManifestItem
  prevPhotoSlug: string
  nextPhotoSlug: string
}

const { photo, prevPhotoSlug, nextPhotoSlug } = Astro.props

// Calculate aspect ratio for determining viewport constraints
const aspectRatio = photo.width / photo.height

// Generate sizes attribute using aspect-ratio media query
// When viewport aspect ratio >= photo aspect ratio: photo is height-constrained
//   -> width = 85vh * aspectRatio
// When viewport aspect ratio < photo aspect ratio: photo is width-constrained
//   -> width = 100vw (minus padding, but we approximate with 100vw)
//
// Express aspect ratio as integer ratio for media query (e.g., 3/2, 16/9)
// Use 1000x precision for accuracy while keeping numbers reasonable
const ratioNumerator = Math.round(aspectRatio * 1000)
const ratioDenominator = 1000
const sizesAttr = `(min-aspect-ratio: ${ratioNumerator}/${ratioDenominator}) calc(85vh * ${aspectRatio.toFixed(4)}), 100vw`

// For maxWidth: use typical large display width (1920px) or original, whichever is smaller
// This generates appropriate srcset widths without creating unnecessarily large images
const maxDisplayWidth = Math.min(photo.width, 1920)

const imageBaseUrl = `${PHOTO_SERVER_URL}/`

// Generate display date and alt text using helpers
const displayDate = getPhotoDisplayDate(photo) || "Unknown date"
const altText = getPhotoAltText(photo, displayDate)

// Generate date URL
let dateUrl: string | null = null

if (photo.dateTaken) {
  dateUrl = `/photos/dates/${photo.dateTaken.substring(0, 10)}/1`
} else if (photo.year && photo.month && photo.day) {
  const monthStr = String(photo.month).padStart(2, "0")
  const dayStr = String(photo.day).padStart(2, "0")
  dateUrl = `/photos/dates/${photo.year}-${monthStr}-${dayStr}/1`
}

// Format exposure time: use fraction for < 1s, direct seconds for >= 1s
let exposureDisplay: string | null = null
if (photo.exposureTime) {
  if (photo.exposureTime < 1) {
    // Format as fraction (e.g., 1/60s)
    const denominator = Math.round(1 / photo.exposureTime)
    exposureDisplay = `1/${denominator}s`
  } else {
    // Format as direct seconds (e.g., 2s)
    exposureDisplay = `${photo.exposureTime}s`
  }
}

// Prepare metadata for the page
const pageTitle = photo.title || `Photo from ${displayDate}`
const pageDescription =
  photo.description || `Photograph taken on ${displayDate}`

// Open Graph image URL (use a medium-sized version)
const ogImageUrl = `${imageBaseUrl}${photo.relativePath}`
---

<BaseLayout
  frontmatter={{
    title: pageTitle,
    description: pageDescription,
    image: ogImageUrl,
    pageType: "photo-gallery",
  }}
>
  <figure id="photo">
    <OptimizedImage
      src={`${imageBaseUrl}${photo.relativePath}`}
      alt={altText}
      width={maxDisplayWidth}
      originalWidth={photo.width}
      originalHeight={photo.height}
      sizesAttr={sizesAttr}
      loading="eager"
    />
    <figcaption>
      {photo.title && <h1>{photo.title}</h1>}
      {photo.description && <p>{photo.description}</p>}

      <h2>Details</h2>
      <dl>
        <dt>Download</dt>
        <dd>
          <a
            href={`${imageBaseUrl}${photo.relativePath}`}
            download
            target="_blank"
            rel="noopener"
          >
            Download original image
          </a>
        </dd>

        <dt>Date taken</dt>
        <dd>
          {dateUrl ? <a href={dateUrl}>{displayDate}</a> : displayDate}
        </dd>

        {
          photo.cameraModel && (
            <>
              <dt>Camera</dt>
              <dd>
                <a
                  href={`/photos/equipment/cameras/${slugify(photo.cameraModel)}/1`}
                >
                  {photo.cameraModel}
                </a>
              </dd>
            </>
          )
        }

        {
          photo.lensModel && (
            <>
              <dt>Lens</dt>
              <dd>
                <a
                  href={`/photos/equipment/lenses/${slugify(photo.lensModel)}/1`}
                >
                  {photo.lensModel}
                </a>
              </dd>
            </>
          )
        }

        {
          photo.focalLength && (
            <>
              <dt>Focal length</dt>
              <dd>
                {photo.focalLengthCategory ? (
                  <a
                    href={`/photos/equipment/focal-length/${photo.focalLengthCategory}/1`}
                  >
                    {photo.focalLength}mm
                    {photo.focalLength35mmEquiv &&
                      ` (${photo.focalLength35mmEquiv}mm equiv.)`}
                  </a>
                ) : (
                  <>
                    {photo.focalLength}mm
                    {photo.focalLength35mmEquiv &&
                      ` (${photo.focalLength35mmEquiv}mm equiv.)`}
                  </>
                )}
              </dd>
            </>
          )
        }

        {
          photo.apertureValue && (
            <>
              <dt>Aperture</dt>
              <dd>f/{photo.apertureValue}</dd>
            </>
          )
        }

        {
          exposureDisplay && (
            <>
              <dt>Exposure</dt>
              <dd>{exposureDisplay}</dd>
            </>
          )
        }

        {
          photo.isoSpeedRatings && (
            <>
              <dt>ISO</dt>
              <dd>{photo.isoSpeedRatings}</dd>
            </>
          )
        }

        {
          photo.flash === true && (
            <>
              <dt>Flash</dt>
              <dd>
                <a href="/photos/equipment/flash/1">Yes</a>
              </dd>
            </>
          )
        }

        {
          photo.tags && photo.tags.length > 0 && (
            <>
              <dt>Tags</dt>
              <dd>
                {photo.tags.map((tag, index) => {
                  const separator = index < photo.tags!.length - 1 ? ", " : ""
                  return (
                    // Keep separator on same line to prevent unwanted whitespace in rendered HTML
                    // prettier-ignore
                    <>
                      <a href={`/photos/tags/${slugify(tag)}/1`}>#{tag}</a>{separator}
                    </>
                  )
                })}
              </dd>
            </>
          )
        }

        {
          photo.creator && (
            <>
              <dt>Creator</dt>
              <dd>{photo.creator}</dd>
            </>
          )
        }

        {
          photo.copyright && (
            <>
              <dt>Copyright</dt>
              <dd>{photo.copyright}</dd>
            </>
          )
        }

        {
          photo.notes && (
            <>
              <dt>Notes</dt>
              <dd>{photo.notes}</dd>
            </>
          )
        }
      </dl>
    </figcaption>
  </figure>

  <nav aria-label="Photo navigation">
    <a
      href={`/photo/${prevPhotoSlug}#photo`}
      rel="prev"
      aria-label="Previous photo"
    >
      <Icon name="ri:arrow-left-s-line" />
    </a>
    <a
      href={`/photo/${nextPhotoSlug}#photo`}
      rel="next"
      aria-label="Next photo"
    >
      <Icon name="ri:arrow-right-s-line" />
    </a>
  </nav>

  <PhotoNavigation />
</BaseLayout>
