---
import BaseLayout from "../../../layouts/BaseLayout.astro"
import type { PhotoManifestItem } from "../../../utils/photoManifestSchema"
import { getCollection } from "astro:content"
import Hero from "../../../components/Hero.astro"
import PhotoNavigation from "../../../components/PhotoNavigation.astro"
import { slugify } from "../../../utils/slugify"
import {
  getUniqueValues,
  countByField,
  formatCount,
} from "../../../utils/collectionHelpers"
import { fontPreloadDefaults } from "../../../config/fontPreload"

// Fetch all photos from the collection (cached by Astro)
const photoEntries = await getCollection("photos")
const allPhotos: PhotoManifestItem[] = photoEntries.map(
  (entry) => entry.data as PhotoManifestItem
)

const uniqueTags = getUniqueValues(allPhotos, (photo) =>
  photo.tags?.map((tag) => tag.toLowerCase())
)
const tagCounts = countByField(allPhotos, (photo) =>
  photo.tags?.map((tag) => tag.toLowerCase())
)

const frontmatter = {
  title: "Photo tags",
  description: "Browse photos by tags.",
}
---

<BaseLayout
  frontmatter={frontmatter}
  fontPreload={fontPreloadDefaults.pageWithSubtitle}
>
  <Hero>
    <h1>{frontmatter.title}</h1>
    <p>Explore photos by tags</p>
  </Hero>

  {
    uniqueTags.length > 0 ? (
      <nav aria-label="Photo tags">
        <ul>
          {uniqueTags.map((tag) => (
            <li>
              <a href={`/photos/tags/${slugify(tag)}/1`}>
                #{tag} {formatCount(tagCounts.get(tag) || 0)}
              </a>
            </li>
          ))}
        </ul>
      </nav>
    ) : (
      <p>No photo tags found.</p>
    )
  }

  <PhotoNavigation currentPage="tags" />
</BaseLayout>
