---
import BaseLayout from "../../../layouts/BaseLayout.astro"
import type { PhotoManifestItem } from "../../../utils/photoManifestSchema"
import { fetchPhotoManifest } from "../../../utils/photoData"

let uniqueTags: string[] = []

try {
  const allPhotos: PhotoManifestItem[] = await fetchPhotoManifest()

  const tagSet = new Set<string>()
  allPhotos.forEach((photo) => {
    if (photo.tags && photo.tags.length > 0) {
      photo.tags.forEach((tag) => tagSet.add(tag.toLowerCase()))
    }
  })
  uniqueTags = Array.from(tagSet).sort((a, b) => a.localeCompare(b))
} catch (e) {
  const error = e as Error
  // fetchPhotoManifest already logs errors. We just need to ensure build fails.
  console.error(
    `Failed to load photo manifest for /photos/tags/index.astro: ${error.message}`
  )
  throw error // Re-throw to fail the build
}

const frontmatter = {
  title: "Photo tags",
  description: "Browse photos by tags.",
}
---

<BaseLayout frontmatter={frontmatter}>
  <h1>{frontmatter.title}</h1>

  {
    uniqueTags.length > 0 ? (
      <nav aria-label="Photo tags">
        <ul>
          {uniqueTags.map((tag) => (
            <li>
              <a href={`/photos/tags/${encodeURIComponent(tag)}/1`}>#{tag}</a>
            </li>
          ))}
        </ul>
      </nav>
    ) : (
      <p>No photo tags found.</p>
    )
  }
</BaseLayout>
