---
import BaseLayout from "../../../layouts/BaseLayout.astro"
import Hero from "../../../components/Hero.astro"
import { getCollection } from "astro:content"
import type { PhotoManifestItem } from "../../../utils/photoManifestSchema"

let uniqueDates: string[] = [] // Stores dates as YYYY-MM-DD strings

// Group dates by year and month
interface GroupedDates {
  [year: string]: {
    [month: string]: string[]
  }
}

let groupedDates: GroupedDates = {}
const monthNames = [
  "January",
  "February",
  "March",
  "April",
  "May",
  "June",
  "July",
  "August",
  "September",
  "October",
  "November",
  "December",
]

// Fetch all photos from the collection (cached by Astro)
const photoEntries = await getCollection("photos")
const allPhotos: PhotoManifestItem[] = photoEntries.map(
  (entry) => entry.data as PhotoManifestItem
)

const dateSet = new Set<string>()
allPhotos.forEach((photo) => {
  let dateStr: string | null = null
  if (photo.dateTaken) {
    dateStr = photo.dateTaken.substring(0, 10) // YYYY-MM-DD from ISO string
  } else if (photo.year && photo.month && photo.day) {
    // Pad month and day with leading zeros if necessary
    const monthStr = String(photo.month).padStart(2, "0")
    const dayStr = String(photo.day).padStart(2, "0")
    dateStr = `${photo.year}-${monthStr}-${dayStr}`
  }
  if (dateStr) {
    dateSet.add(dateStr)
  }
})
uniqueDates = Array.from(dateSet).sort((a, b) => b.localeCompare(a)) // Sort YYYY-MM-DD strings, recent first

uniqueDates.forEach((dateStr) => {
  const [year, monthNumStr] = dateStr.split("-")
  const monthIndex = parseInt(monthNumStr, 10) - 1
  const monthName = monthNames[monthIndex]

  if (!groupedDates[year]) {
    groupedDates[year] = {}
  }
  if (!groupedDates[year][monthName]) {
    groupedDates[year][monthName] = []
  }
  groupedDates[year][monthName].push(dateStr)
})

const frontmatter = {
  title: "Photo dates",
  description: "Browse photos by date taken.",
}
---

<BaseLayout frontmatter={frontmatter}>
  <Hero>
    <h1>{frontmatter.title}</h1>
    <p>{frontmatter.description}</p>
  </Hero>
  <nav>
    {
      Object.keys(groupedDates).length > 0 ? (
        <ol>
          {Object.keys(groupedDates)
            .sort((a, b) => b.localeCompare(a))
            .map((year) => (
              <li>
                <h2>{year}</h2>
                <ol>
                  {Object.keys(groupedDates[year])
                    .sort(
                      (a, b) => monthNames.indexOf(b) - monthNames.indexOf(a)
                    )
                    .map((monthName) => (
                      <li>
                        <h3>{monthName}</h3>
                        <ul>
                          {groupedDates[year][monthName]
                            .sort((a, b) => a.localeCompare(b))
                            .map((date: string) => {
                              const day = parseInt(date.split("-")[2], 10)
                              return (
                                <li>
                                  <a href={`/photos/dates/${date}/1`}>{day}</a>
                                </li>
                              )
                            })}
                        </ul>
                      </li>
                    ))}
                </ol>
              </li>
            ))}
        </ol>
      ) : (
        <p>No photo dates found.</p>
      )
    }
  </nav>
  <nav>
    <ul>
      <li><a href="/photos/all/1">All photos</a></li>
      <li><a href="/photos/tags">Browse by tags</a></li>
    </ul>
  </nav>
</BaseLayout>
