---
import BaseLayout from "../../../layouts/BaseLayout.astro"
import Hero from "../../../components/Hero.astro"
import PhotoNavigation from "../../../components/PhotoNavigation.astro"
import type { PhotoManifestItem } from "../../../utils/photoManifestSchema"
import { getCollection } from "astro:content"
import { slugify } from "../../../utils/slugify"
import {
  getUniqueValues,
  countByField,
  formatCount,
} from "../../../utils/collectionHelpers"

// Fetch all photos to build equipment lists
const photoEntries = await getCollection("photos")
const allPhotos: PhotoManifestItem[] = photoEntries.map(
  (entry) => entry.data as PhotoManifestItem
)

// Gather cameras
const uniqueCameras = getUniqueValues(allPhotos, (photo) => photo.cameraModel)
const cameraCounts = countByField(allPhotos, (photo) => photo.cameraModel)

// Gather lenses
const uniqueLenses = getUniqueValues(allPhotos, (photo) => photo.lensModel)
const lensCounts = countByField(allPhotos, (photo) => photo.lensModel)

// Gather focal length categories
const categoryInfo: Record<string, { name: string; description: string }> = {
  "ultra-wide": {
    name: "Ultra-Wide",
    description: "under 24mm",
  },
  wide: {
    name: "Wide",
    description: "24-34mm",
  },
  normal: {
    name: "Normal",
    description: "35-69mm",
  },
  "short-telephoto": {
    name: "Short Telephoto",
    description: "70-134mm",
  },
  telephoto: {
    name: "Telephoto",
    description: "135-299mm",
  },
  "super-telephoto": {
    name: "Super Telephoto",
    description: "300mm and above",
  },
}

const categoryCounts = countByField(
  allPhotos,
  (photo) => photo.focalLengthCategory
)

// Count flash photos
const flashCount = allPhotos.filter((photo) => photo.flash === true).length

const frontmatter = {
  title: "Browse by Equipment & Settings",
  description:
    "Explore photos by camera, lens, focal length, and flash settings.",
}
---

<BaseLayout frontmatter={frontmatter}>
  <Hero>
    <h1>{frontmatter.title}</h1>
    <p>{frontmatter.description}</p>
  </Hero>

  <nav aria-label="Equipment categories">
    <ul>
      <li>
        <h2>Cameras</h2>
        {
          uniqueCameras.length > 0 ? (
            <ul>
              {uniqueCameras.map((camera) => (
                <li>
                  <a href={`/photos/equipment/cameras/${slugify(camera)}/1`}>
                    {camera} {formatCount(cameraCounts.get(camera) || 0)}
                  </a>
                </li>
              ))}
            </ul>
          ) : (
            <p>No camera information found.</p>
          )
        }
      </li>
      <li>
        <h2>Lenses</h2>
        {
          uniqueLenses.length > 0 ? (
            <ul>
              {uniqueLenses.map((lens) => (
                <li>
                  <a href={`/photos/equipment/lenses/${slugify(lens)}/1`}>
                    {lens} {formatCount(lensCounts.get(lens) || 0)}
                  </a>
                </li>
              ))}
            </ul>
          ) : (
            <p>No lens information found.</p>
          )
        }
      </li>
      <li>
        <h2>Focal Length</h2>
        {
          categoryCounts.size > 0 ? (
            <ul>
              {Object.entries(categoryInfo).map(([key, info]) => {
                const count = categoryCounts.get(key) || 0
                if (count === 0) return null
                return (
                  <li>
                    <a
                      href={`/photos/equipment/focal-length/${key}/1`}
                      title={info.description}
                    >
                      {info.name} {formatCount(count)}
                    </a>
                  </li>
                )
              })}
            </ul>
          ) : (
            <p>No focal length information found.</p>
          )
        }
      </li>
      <li>
        <h2>Flash</h2>
        {
          flashCount > 0 ? (
            <p>
              <a href="/photos/equipment/flash/1">
                Photos taken with flash {formatCount(flashCount)}
              </a>
            </p>
          ) : (
            <p>No photos taken with flash.</p>
          )
        }
      </li>
    </ul>
  </nav>

  <PhotoNavigation currentPage="equipment" />
</BaseLayout>
