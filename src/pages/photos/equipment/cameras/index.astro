---
import BaseLayout from "../../../../layouts/BaseLayout.astro"
import type { PhotoManifestItem } from "../../../../utils/photoManifestSchema"
import { getCollection } from "astro:content"
import Hero from "../../../../components/Hero.astro"
import PhotoNavigation from "../../../../components/PhotoNavigation.astro"
import { slugify } from "../../../../utils/slugify"
import {
  getUniqueValues,
  countByField,
  formatCount,
} from "../../../../utils/collectionHelpers"
import { fontPreloadDefaults } from "../../../../config/fontPreload"

// Fetch all photos from the collection (cached by Astro)
const photoEntries = await getCollection("photos")
const allPhotos: PhotoManifestItem[] = photoEntries.map(
  (entry) => entry.data as PhotoManifestItem
)

const uniqueCameras = getUniqueValues(allPhotos, (photo) => photo.cameraModel)
const cameraCounts = countByField(allPhotos, (photo) => photo.cameraModel)

const frontmatter = {
  title: "Browse by Camera",
  description: "Explore photos grouped by camera model.",
}
---

<BaseLayout
  frontmatter={frontmatter}
  fontPreload={fontPreloadDefaults.pageWithSubtitle}
>
  <Hero>
    <h1>{frontmatter.title}</h1>
    <p>{frontmatter.description}</p>
  </Hero>

  {
    uniqueCameras.length > 0 ? (
      <nav aria-label="Camera models">
        <ul>
          {uniqueCameras.map((camera) => (
            <li>
              <a href={`/photos/equipment/cameras/${slugify(camera)}/1`}>
                {camera} {formatCount(cameraCounts.get(camera) || 0)}
              </a>
            </li>
          ))}
        </ul>
      </nav>
    ) : (
      <p>No camera information found.</p>
    )
  }

  <PhotoNavigation currentPage="equipment" />
</BaseLayout>
