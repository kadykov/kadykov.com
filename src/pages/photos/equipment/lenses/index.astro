---
import BaseLayout from "../../../../layouts/BaseLayout.astro"
import type { PhotoManifestItem } from "../../../../utils/photoManifestSchema"
import { getCollection } from "astro:content"
import Hero from "../../../../components/Hero.astro"
import PhotoNavigation from "../../../../components/PhotoNavigation.astro"
import { slugify } from "../../../../utils/slugify"
import {
  getUniqueValues,
  countByField,
  formatCount,
} from "../../../../utils/collectionHelpers"

// Fetch all photos from the collection (cached by Astro)
const photoEntries = await getCollection("photos")
const allPhotos: PhotoManifestItem[] = photoEntries.map(
  (entry) => entry.data as PhotoManifestItem
)

const uniqueLenses = getUniqueValues(allPhotos, (photo) => photo.lensModel)
const lensCounts = countByField(allPhotos, (photo) => photo.lensModel)

const frontmatter = {
  title: "Browse by Lens",
  description: "Explore photos grouped by lens model.",
}
---

<BaseLayout frontmatter={frontmatter}>
  <Hero>
    <h1>{frontmatter.title}</h1>
    <p>{frontmatter.description}</p>
  </Hero>

  {
    uniqueLenses.length > 0 ? (
      <nav aria-label="Lens models">
        <ul>
          {uniqueLenses.map((lens) => (
            <li>
              <a href={`/photos/equipment/lenses/${slugify(lens)}/1`}>
                {lens} {formatCount(lensCounts.get(lens) || 0)}
              </a>
            </li>
          ))}
        </ul>
      </nav>
    ) : (
      <p>No lens information found.</p>
    )
  }

  <PhotoNavigation currentPage="equipment" />
</BaseLayout>
