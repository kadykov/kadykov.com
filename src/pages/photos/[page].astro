---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PhotoGallery from '../../components/PhotoGallery.astro';
import type { PhotoManifestItem } from '../../utils/photoManifestSchema'; // No longer need photoManifestSchema here
import { fetchPhotoManifest } from '../../utils/photoData';
import type { Page, PaginateFunction } from 'astro';

// Define PAGE_SIZE for pagination
// const PAGE_SIZE = 24; // This comment is fine, PAGE_SIZE is defined inside getStaticPaths

export async function getStaticPaths({ paginate }: { paginate: PaginateFunction }) {
  const PAGE_SIZE = 24; // Defined inside function

  let allPhotos: PhotoManifestItem[] = [];
  try {
    allPhotos = await fetchPhotoManifest();
  } catch (e) {
    const error = e as Error;
    // fetchPhotoManifest already logs errors. We just need to ensure build fails.
    console.error(`Failed to load photo manifest for /photos/[page].astro: ${error.message}`);
    throw error; // Re-throw to fail the build
  }

  // Sort photos by dateTaken, most recent first.
  // Handle null dateTaken values by pushing them to the end.
  allPhotos.sort((a, b) => {
    if (a.dateTaken && b.dateTaken) {
      return new Date(b.dateTaken).getTime() - new Date(a.dateTaken).getTime();
    }
    if (a.dateTaken) return -1; // a has date, b doesn't, so a comes first
    if (b.dateTaken) return 1;  // b has date, a doesn't, so b comes first
    return 0; // both null
  });

  // The paginate function will generate params like { page: "1" }, { page: "2" }
  // because the filename is [page].astro
  return paginate(allPhotos, { pageSize: PAGE_SIZE });
}

interface Props {
  page: Page<PhotoManifestItem>;
}

const { page } = Astro.props;

if (!page) {
  console.error("CRITICAL: 'page' prop is undefined in /photos/[page].astro. Astro.props:", JSON.stringify(Astro.props)); // Updated log message
  // This will likely still lead to an error below, but the log might provide insight.
  // Or, we could throw here: throw new Error("'page' prop is undefined!");
}

// Reverted optional chaining to let errors surface if page is undefined.
const pageTitle = `All Photos${page.currentPage > 1 ? ` (Page ${page.currentPage})` : ''}`;
const pageDescription = `A collection of all photos. Page ${page.currentPage} of ${page.lastPage}.`;
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-heading-1 mb-8 text-center">{pageTitle}</h1>

    <PhotoGallery photos={page.data} />

    {page.lastPage > 1 && (
      <nav class="mt-12 flex justify-center items-center space-x-4" aria-label="Pagination">
        {page.url.prev ? (
          <a href={page.url.prev} class="btn btn-outline">
            &laquo; Previous
          </a>
        ) : (
          <span class="btn btn-outline btn-disabled" aria-disabled="true">&laquo; Previous</span>
        )}

        <span>Page {page.currentPage} of {page.lastPage}</span>

        {page.url.next ? (
          <a href={page.url.next} class="btn btn-outline">
            Next &raquo;
          </a>
        ) : (
          <span class="btn btn-outline btn-disabled" aria-disabled="true">Next &raquo;</span>
        )}
      </nav>
    )}
  </div>
</BaseLayout>
