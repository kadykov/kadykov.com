---
import BaseLayout from "../../../layouts/BaseLayout.astro"
import { getCollection } from "astro:content"
import Hero from "../../../components/Hero.astro"
import BlogPostListItem from "../../../components/BlogPostListItem.astro"
import { slugify } from "../../../utils/slugify"

export async function getStaticPaths() {
  const allPosts = await getCollection(
    "blog",
    ({ data }) => data.draft !== true
  )
  // Ensure tags array is not undefined before flat() and filter for valid tags
  const validTags = allPosts
    .map((post) => post.data.tags)
    .flat()
    .filter((tag) => typeof tag === "string" && tag.trim() !== "") // Filter out undefined/empty tags
  const uniqueTags = [...new Set(validTags)]

  return uniqueTags.map((tag) => {
    const filteredPosts = allPosts.filter(
      (post) => post.data.tags && post.data.tags.includes(tag) // Check if post.data.tags exists
    )
    return {
      params: { tag: slugify(tag) }, // Slugify the tag for URL
      props: { posts: filteredPosts, tagDisplayName: tag }, // Pass original tag for display
    }
  })
}

const { posts, tagDisplayName } = Astro.props

const frontmatter = {
  title: `Tagged: ${tagDisplayName}`,
  description: `Blog posts tagged with ${tagDisplayName}`,
}
---

<BaseLayout frontmatter={frontmatter}>
  <Hero>
    <h1>{frontmatter.title}</h1>
    <p>Posts tagged with #{tagDisplayName}</p>
  </Hero>

  {
    posts && posts.length > 0 ? (
      <ol>
        {posts.map((post) => (
          <BlogPostListItem post={post} />
        ))}
      </ol>
    ) : (
      <p>No posts found for this tag.</p>
    )
  }

  <nav>
    <ul>
      <li>
        <a href="/blog/tags">Browse all tags</a>
      </li>
      <li>
        <a href="/blog">All blog posts</a>
      </li>
    </ul>
  </nav>
</BaseLayout>
