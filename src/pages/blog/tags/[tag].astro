---
import BaseLayout from "../../../layouts/BaseLayout.astro"
import { getCollection } from "astro:content"
import Hero from "../../../components/Hero.astro"
import BlogPostListItem from "../../../components/BlogPostListItem.astro"

export async function getStaticPaths() {
  const allPosts = await getCollection("blog")
  // Ensure tags array is not undefined before flat() and filter for valid tags
  const validTags = allPosts
    .map((post) => post.data.tags)
    .flat()
    .filter((tag) => typeof tag === "string" && tag.trim() !== "") // Filter out undefined/empty tags
  const uniqueTags = [...new Set(validTags)]

  return uniqueTags.map((tag) => {
    const filteredPosts = allPosts.filter(
      (post) => post.data.tags && post.data.tags.includes(tag) // Check if post.data.tags exists
    )
    return {
      params: { tag: tag! }, // Assert tag is not undefined
      props: { posts: filteredPosts },
    }
  })
}

const { tag } = Astro.params
const { posts } = Astro.props

const frontmatter = {
  title: `Tagged: ${tag}`,
  description: `Blog posts tagged with ${tag}`,
}
---

<BaseLayout frontmatter={frontmatter}>
  <Hero>
    <h1>{frontmatter.title}</h1>
    <p>Posts tagged with #{tag}</p>
  </Hero>

  {
    posts && posts.length > 0 ? (
      <ol>
        {posts.map((post) => (
          <BlogPostListItem post={post} />
        ))}
      </ol>
    ) : (
      <p>No posts found for this tag.</p>
    )
  }

  <nav>
    <ul>
      <li>
        <a href="/blog/tags">Browse all tags</a>
      </li>
      <li>
        <a href="/blog">All blog posts</a>
      </li>
    </ul>
  </nav>
</BaseLayout>
